# ğŸ•¸ï¸ ä¼šè¯æŠ€æœ¯è¯¦è§£ï¼šSessionã€Cookieã€JWTã€Filter ä¸ Interceptor
## ä¼šè¯æŠ€æœ¯æ¦‚è¿°
å½“ç”¨æˆ·æ‰“å¼€æµè§ˆå™¨è®¿é—® Web æœåŠ¡å™¨èµ„æºæ—¶ï¼Œä¼šè¯ï¼ˆSessionï¼‰éšä¹‹å»ºç«‹ï¼Œç›´åˆ°ä¸€æ–¹æ–­å¼€è¿æ¥ä¸ºæ­¢ã€‚ä¸€æ¬¡ä¼šè¯ä¸­å¯ä»¥åŒ…å«å¤šæ¬¡è¯·æ±‚å’Œå“åº”ã€‚

## ä¼šè¯è·Ÿè¸ª
ä¼šè¯è·Ÿè¸ªæ˜¯ä¸€ç§ç»´æŠ¤æµè§ˆå™¨çŠ¶æ€çš„æŠ€æœ¯ã€‚æœåŠ¡å™¨é€šè¿‡è¯†åˆ«æ˜¯å¦ä¸ºåŒä¸€æµè§ˆå™¨çš„å¤šæ¬¡è¯·æ±‚ï¼Œå®ç°è·¨è¯·æ±‚çš„æ•°æ®å…±äº«ã€‚

## ä¼šè¯è·Ÿè¸ªæ–¹æ¡ˆ
ä¸‰ç§ä¸»æµæ–¹å¼ï¼š

å®¢æˆ·ç«¯ï¼šCookie

æœåŠ¡ç«¯ï¼šSession

ä»¤ç‰Œæœºåˆ¶ï¼šToken / JWT

## ä¸€ã€å®¢æˆ·ç«¯ä¼šè¯è·Ÿè¸ªæŠ€æœ¯ï¼šCookie
```java
// è®¾ç½® Cookie
@GetMapping("/c1")
public Result cookiel(HttpServletResponse respones) {
    respones.addCookie(new Cookie("login_username", "itheima"));
    return Result.success();
}

// è·å– Cookie
@GetMapping("/c2")
public Result cookie2(HttpServletRequest request) {
    Cookie[] cookies = request.getCookies();
    for (Cookie cookie : cookies) {
        if(cookie.getName().equals("login_username")) {
            System.out.println("login_username: " + cookie.getValue());
        }
    }
    return Result.success();
}
```
âœ… ä¼˜ç‚¹
å±äº HTTP åè®®æœ¬èº«ï¼Œæ”¯æŒåº¦å¹¿

âŒ ç¼ºç‚¹
ç§»åŠ¨ç«¯ App æ— æ³•ä½¿ç”¨ã€å®¹æ˜“è¢«ç”¨æˆ·ç¦ç”¨ã€ä¸æ”¯æŒè·¨åŸŸä¼ é€’ï¼Œå®‰å…¨æ€§è¾ƒä½

## äºŒã€æœåŠ¡ç«¯ä¼šè¯è·Ÿè¸ªæŠ€æœ¯ï¼šSession
```java
// å‘ Session ä¸­å­˜å‚¨æ•°æ®
@GetMapping("/s1")
public Result Session(HttpSession session) {
    log.info("HttpSession-s1: {}", session.hashCode());
    session.setAttribute("loginUser", "tom");
    return Result.success();
}

// ä» Session ä¸­è·å–æ•°æ®
@GetMapping("/s2")
public Result Session2(HttpServletRequest request) {
    HttpSession session = request.getSession();
    log.info("HttpSession-s2: {}", session.hashCode());

    Object loginUser = session.getAttribute("loginUser");
    log.info("loginUser: {}", loginUser);
    return Result.success(loginUser);
}
```
âœ… ä¼˜ç‚¹
å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œå®‰å…¨æ€§é«˜

âŒ ç¼ºç‚¹
ä¸é€‚ç”¨äºåˆ†å¸ƒå¼/é›†ç¾¤æ¶æ„ã€ä»ä¾èµ– Cookie å‚¨å­˜ sessionId

## ä¸‰ã€ä»¤ç‰ŒæŠ€æœ¯ï¼šToken / JWT


ğŸ” JWTï¼ˆJSON Web Tokenï¼‰
JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

Headerï¼šè®°å½•ä»¤ç‰Œç±»å‹ã€ç­¾åç®—æ³•

Payloadï¼šè‡ªå®šä¹‰ä¿¡æ¯

Signatureï¼šç­¾åï¼Œç¡®ä¿ä»¤ç‰Œæœªè¢«ç¯¡æ”¹

ğŸ”§ ç”Ÿæˆ JWT
```java
@Test
public void testGenJwt() {
    Map<String,Object> claims = new HashMap<>();
    claims.put("id", 1);
    claims.put("name", "tom");

    SecretKey key = Keys.hmacShaKeyFor("itheima-itheima-itheima-itheima-1".getBytes());

    String jwt = Jwts.builder()
            .signWith(key, SignatureAlgorithm.HS256)
            .setClaims(claims)
            .setExpiration(new Date(System.currentTimeMillis() + 3600 * 1000)) // 1å°æ—¶
            .compact();

    System.out.println(jwt);
}
```
ğŸ” è§£æ JWT
```java
@Test
public void testParseJwt() {
    SecretKey key = Keys.hmacShaKeyFor("itheima-itheima-itheima-itheima-1".getBytes());

    Claims claims = Jwts.parserBuilder()
            .setSigningKey(key)
            .build()
            .parseClaimsJws("xxx.yyy.zzz") // æ›¿æ¢ä¸ºå®é™… JWT å­—ç¬¦ä¸²
            .getBody();

    System.out.println(claims);
}
```
âœ… ä¼˜ç‚¹
æ”¯æŒ PC + ç§»åŠ¨ç«¯ã€ä¸ä¾èµ– Sessionï¼Œå¯ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿã€å‡å°‘æœåŠ¡ç«¯å­˜å‚¨è´Ÿæ‹…

âŒ ç¼ºç‚¹
å®ç°å’Œç»´æŠ¤å¤æ‚åº¦è¾ƒé«˜
## å››ã€Filter è¿‡æ»¤å™¨ï¼ˆåŸå§‹ Servlet æ–¹æ¡ˆï¼‰
```java
@Slf4j
@WebFilter("/*")
public class LoginCheackFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;

        String url = req.getRequestURL().toString();
        log.info("è¯·æ±‚çš„URI: {}", url);

        if (url.contains("login")) {
            chain.doFilter(request, response);
            return;
        }

        String jwt = req.getHeader("token");

        if (StringUtils.isEmpty(jwt)) {
            String notLogin = JSON.toJSONString(Result.error("NOT_LOGIN"));
            resp.getWriter().write(notLogin);
            return;
        }

        try {
            JwtUtils.parseJWT(jwt);
        } catch (Exception e) {
            log.error("JWTè§£æå¤±è´¥");
            String notLogin = JSON.toJSONString(Result.error("NOT_LOGIN"));
            resp.getWriter().write(notLogin);
            return;
        }

        chain.doFilter(request, response);
    }
}
```

## äº”ã€Interceptor æ‹¦æˆªå™¨ï¼ˆSpringMVCæ–¹æ¡ˆï¼‰
1ï¸âƒ£ æ³¨å†Œæ‹¦æˆªå™¨
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Autowired
    private LoginCheackInterceptor loginCheackInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(loginCheackInterceptor)
                .addPathPatterns("/**")
                .excludePathPatterns("/login");
    }
}
```
2ï¸âƒ£ å®ç°æ‹¦æˆªå™¨é€»è¾‘
```java
@Slf4j
@Component
public class LoginCheackInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest req, HttpServletResponse resp, Object handler) throws Exception {
        String url = req.getRequestURL().toString();
        log.info("è¯·æ±‚çš„URI: {}", url);

        if (url.contains("login")) return true;

        String jwt = req.getHeader("token");
        if (StringUtils.isEmpty(jwt)) {
            resp.getWriter().write(JSON.toJSONString(Result.error("NOT_LOGIN")));
            return false;
        }

        try {
            JwtUtils.parseJWT(jwt);
        } catch (Exception e) {
            log.error("JWTè§£æå¤±è´¥");
            resp.getWriter().write(JSON.toJSONString(Result.error("NOT_LOGIN")));
            return false;
        }

        return true;
    }

    @Override
    public void postHandle(HttpServletRequest req, HttpServletResponse resp, Object handler, ModelAndView modelAndView) {
        log.info("postHandle...");
    }

    @Override
    public void afterCompletion(HttpServletRequest req, HttpServletResponse resp, Object handler, Exception ex) {
        log.info("afterCompletion...");
    }
}
```
## å…­ã€Filter ä¸ Interceptor å¯¹æ¯”
| é¡¹ç›®   | Filter                                   | Interceptor                        |
| ---- | ---------------------------------------- | ---------------------------------- |
| æ¥å£   | å®ç° `javax.servlet.Filter`                | å®ç° `HandlerInterceptor` æ¥å£         |
| æ‹¦æˆªèŒƒå›´ | æ‰€æœ‰è¯·æ±‚ï¼ˆåŒ…æ‹¬é™æ€èµ„æºï¼‰                             | ä»…æ‹¦æˆª SpringMVC æ§åˆ¶å™¨ç›¸å…³èµ„æº              |
| æ‰§è¡Œé¡ºåº | Filter â†’ DispatcherServlet â†’ Interceptor | Interceptor åœ¨ DispatcherServlet ä¹‹å |
| åœºæ™¯   | ç™»å½•éªŒè¯ã€æƒé™æ§åˆ¶ã€è·¨åŸŸç­‰é€šç”¨åœºæ™¯                        | Spring å†…éƒ¨ä¸šåŠ¡é€»è¾‘æ§åˆ¶ï¼Œå¦‚é‰´æƒã€æ—¥å¿—             |

